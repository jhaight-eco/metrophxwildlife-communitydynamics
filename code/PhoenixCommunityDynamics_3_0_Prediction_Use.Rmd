---
title: "Metro Phoenix Wildlife Study - Community Dynamics - Predicting Use, Persistence, and Occupancy"
author: "Jeffrey Haight"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls()) # clear the environment
gc()


# Set working directory
#setwd("G:/My Drive/ASU/Jeff-Jesse-Sharon Document Sharing/Dissertation/Chapter1_PhoenixCommDynamics/analysis")

  # Load necessary packages
  #library(dplyr)
  library(tidyverse)
  library(abind)
  
  # modeling packages
  library(jagsUI)
  library(runjags)
  
  # visualization packages
  library(flextable)
  library(ggplot2)
  library(gghighlight)
  library(viridis)
  library(RColorBrewer)
  library(nationalparkcolors)
  library(png)

```

```{r import data}
#### Import Data ####
  setwd("~/GitHub/metrophxwildlife-communitydynamics")

  # all the data input into the models
  load("./data/model_inputs/ModelInputData_DCM.RData")
  # The main dataset containing all the site and regional covariates 
  # and summarized community composition parameters
  data <- read.csv("./data/model_outputs/data_PhoenixCommDynamics.csv")
  
  # the model object
   # the smaller version of the model
  #out <- readRDS("./data/model_outputs/DCM_global/globalDCM_sample6k.rds")   
  
  # The full version of the model
  # this file is too large to share in the Github repository, 
  # but it can be reproduced by re-running the model code in the file ''
  # This file is also available at request to the corresponding author Jeff Haight
  out <- readRDS("C:/Research/urban/CAPLTER/projects/MetroPhoenixWildlifeStudy/CH1_communitydynamics/analysis/data/5_output/globalDCMnoquadurb_sample30k.rds")    

 
  tmp <- out$sims.list
  nsamp <- length(tmp[[1]])
  
  rm(out)
  gc()
  
  # total number of species in the modeled community
  nspec <- 22
  
```
# Examine community-average effects
```{r}
# Where does the effect of urbanization peak?
  # x = urbanization. Solve for 'urban' and you get where the peak in the relationship is 
  #(as a standardized urbanization value)
  # logis(psi) = beta1*x + beta2*x^2 + 0 + 0
  # 0 = beta1 + 2*beta2*x
  # x = -1*beta1/(2*beta2)
  
  # standardized values of imperviousness
    (peak.psi <- -1*mean(tmp$mu.beta1.psi)/mean(tmp$mu.beta2.psi)/2)
    (peak.phi <- -1*mean(tmp$mu.beta1.phi)/mean(tmp$mu.beta2.phi)/2 )
    (peak.gamma <- -1*mean(tmp$mu.beta1.gamma)/mean(tmp$mu.beta2.gamma)/2)
  # de-standardized them
    (peak.psi)*sd(data.site$imp1km)+mean(data.site$imp1km)
    # the 'peak' in psi1 would theoretically occur at negative urbanization, i.e., it doesn't really exist
    (peak.phi)*sd(data.site$imp1km)+mean(data.site$imp1km)
    # there is a 'peak', but that this wasn't a substantial quadratic term for persistence, so it is not quadratic by our assessment
    (peak.gamma)*sd(data.site$imp1km)+mean(data.site$imp1km)
    # this is the only parameter in the whole analysis with a substantial quadratic relationship
    # and the peak is at ~16.5% urbanization
```


# Setup for Predictions
Set some general items for predicting parameters across ranges of idealized (hypothetical) trait values, including design matrices of environmental and species trait covariates where other values are held constant


```{r design matrices environmental}
# number of hypothetical environmental parameters to predict off of
  npred <- 200

# sets of hypothetical covariate values to predict off of
    dm.urb <- cbind(
      1,# intercept
      seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred), #urban
      # seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred)^2, # urbanization quadratic term
      0, # patch diversity
      0  # veg greenness. This was standardized by season
    )
    dm.het <- cbind(
      1,# intercept
      0, #urban
      # 0, # urbanization quadratic term
      seq(min(data$sdhi5km_std), max(data$sdhi5km_std), length.out = npred), # patch diversity
      0  # veg greenness
    )
    dm.veg <- cbind(
      1,# intercept
      0, #urban
      # 0, # urbanization quadratic term
      0, # patch diversity
      seq(min(ndvi.1km.std), max(ndvi.1km.std), length.out = npred)  # veg greenness
    )
```

```{r explore traits}
# find species with similar diets, but contrasting body sizes (the strict herbivores vs. carnivores would make sense)
  data.spp %>% arrange(dietdiv) %>% select(c(name_short, logmass, BodyMass.Value, dietdiv))
  # "cottontail_desert", "mountain_lion", "bobcat", "jackrabbit_bt"

# find species with similar body masses, but contrasting diets
  data.spp %>% arrange(logmass) %>% select(c(name_short, logmass, BodyMass.Value, dietdiv))
  # "bobcat", "badger", "raccoon", "jackrabbit_bt"
```

```{r design matrices spp traits}
    data.spp %>% arrange(dietdiv) %>% select(name, logmass, dietdiv)
  
  # sequences of hypothetical trait values, non-standardized
    range(data.spp$BodyMass.Value)
    range(data.spp$dietdiv)
    plot.bm <- c(log10(1000), log10(5000), log10(20000))
    # 1000 g = roughly the size of a cottontail
    # 5000 g = between fox and raccoon
    # 20000 g = about the size of a javelina
    
    quantile(data.spp$dietdiv)
    # 0 = obligate carnivores and herbivores. That is more extreme than just a diet specialist
    # 0.325 = the least diverse diet that isn't 100% one category
    # 1.557 = the most omnivorous species
    #plot.di <- c(min(data.spp$dietdiv), mean(data.spp$dietdiv), max(data.spp$dietdiv))
    plot.di <- c(0.325, mean(data.spp$dietdiv), max(data.spp$dietdiv))
    
    #plot.bm <- c(min(data.spp$logmass), mean(data.spp$logmass), max(data.spp$logmass))
    #plot.di <- c(min(data.spp$dietdiv), mean(data.spp$dietdiv), max(data.spp$dietdiv))
    
    # standardize the sequences of hypothetical trait values, 
    nspec.pred <- length(plot.bm)
    #(seq.bm <- seq(min(data.spp$logmass_std), max(data.spp$logmass_std), length.out = nspec.pred))
    #(seq.di <- seq(min(data.spp$dietdiv_std), max(data.spp$dietdiv_std), length.out = nspec.pred))
    (seq.bm <- (plot.bm - mean(data.spp$logmass)/sd(data.spp$logmass)))
    (seq.di <- (plot.di - mean(data.spp$dietdiv)/sd(data.spp$dietdiv)))
    
    seq.di*sd(data.spp$dietdiv)+mean(data.spp$dietdiv)
    # create a design matrix based on the equations: 1 = intercept, seq. = trait values to predict off of
    dm.bm <- cbind(1, seq.bm, 0)      
    dm.di <- cbind(1, 0, seq.di) 
```


# Extract MCMC Parameter Distributions
Pull out the mcmc samples of each intercept and slope parameter and put them into large matrices  

### Community-average parameters
```{r}
mu.beta.psi <- cbind (
        tmp$mu.lpsi1,
        tmp$mu.beta1.psi,
        # tmp$mu.beta2.psi,
        tmp$mu.beta3.psi,
        tmp$mu.beta4.psi
      )
      
      
      mu.beta.phi <- cbind (
        tmp$mu.lphi,
        tmp$mu.beta1.phi,
        # tmp$mu.beta2.phi,
        tmp$mu.beta3.phi,
        tmp$mu.beta4.phi
      )
      
      mu.beta.gamma <- cbind (
        tmp$mu.lgamma,
        tmp$mu.beta1.gamma,
        # tmp$mu.beta2.gamma,
        tmp$mu.beta3.gamma,
        tmp$mu.beta4.gamma
      )
```

### Species-specific parameters
```{r}
      beta.psi <- abind (
        tmp$lpsi1,
        tmp$beta1.psi,
        # tmp$beta2.psi,
        tmp$beta3.psi,
        tmp$beta4.psi,
        along = 3
      )
      
      
      beta.phi <- abind (
        tmp$lphi,
        tmp$beta1.phi,
        # tmp$beta2.phi,
        tmp$beta3.phi,
        tmp$beta4.phi,
        along = 3
      )
      
      beta.gamma <- abind (
        tmp$lgamma,
        tmp$beta1.gamma,
        # tmp$beta2.gamma,
        tmp$beta3.gamma,
        tmp$beta4.gamma,
        along = 3
      )      
```



### Examine Community-average Slopes
```{r}
# # Where does the effect of urbanization peak?
#       # 0 = beta1*urban + beta2*urban^2 
#       # solve for 'urban' and you get where the peak in the relationship is
#       # standardized values of imperviousness
#           mean(tmp$mu.beta1.psi)/mean(tmp$mu.beta2.psi)*-1
#           mean(tmp$mu.beta1.phi)/mean(tmp$mu.beta2.phi)*-1  
#           mean(tmp$mu.beta1.gamma)/mean(tmp$mu.beta2.gamma)*-1
#       # de-standardized them
#           (mean(tmp$mu.beta1.psi)/mean(tmp$mu.beta2.psi)*-1)*sd(data$imp1km)+mean(data$imp1km)
#         # the 'peak' in psi1 would theoretically occur at negative urbanization
#           (mean(tmp$mu.beta1.phi)/mean(tmp$mu.beta2.phi)*-1)*sd(data$imp1km)+mean(data$imp1km)
#         # note that this wasn't a substantial quadratic term for persistence, so really there 
#           (mean(tmp$mu.beta1.gamma)/mean(tmp$mu.beta2.gamma)*-1)*sd(data$imp1km)+mean(data$imp1km)
```


# Predict Against Environmental Covariates
Since we use matrix algebra for the community-average predictions, with no for loops, we don't need objects to store those values in.

### Community-level parameters vs. environmental covariates
```{r}
# hold all other values at their mean value, for illustration
    # doing this using matrix math is muuuch quicker than massive 'for' loops
  
    # Urbanization, Psi1, community-average
    mu.psi.urb <- plogis(mu.beta.psi %*% t(dm.urb))
    
    
    # Urbanization, Phi, community-average
    mu.phi.urb <- plogis(mu.beta.phi %*% t(dm.urb))
    
    
    # Urbanization, Gamma, community-average
    mu.gamma.urb <- plogis(mu.beta.gamma %*% t(dm.urb))
    
    
    # Patch Diversity, Psi1, community-average
    mu.psi.het <- plogis(mu.beta.psi %*% t(dm.het))
    
    # Patch Diversity, Phi, community-average
    mu.phi.het <- plogis(mu.beta.phi %*% t(dm.het))
    
    # Patch Diversity, Gamma, community-average
    mu.gamma.het <- plogis(mu.beta.gamma %*% t(dm.het))
    
    
    # Vegetation, Psi1, community-average
    mu.psi.veg <- plogis(mu.beta.psi %*% t(dm.veg))
    
    
    # Vegetation, Phi, community-average
    mu.phi.veg <- plogis(mu.beta.phi %*% t(dm.veg))
    
    
    # Vegetation, Gamma, community-average
    mu.gamma.veg <- plogis(mu.beta.gamma %*% t(dm.veg))
    #for(i in 1:npred){
    #  for(k in 1:nsamp){
    #    mu.gamma.veg[k,i] <- plogis(
    #      tmp$mu.lgamma[k] + 
    #        tmp$mu.beta1.gamma[k]*0 +
    #        tmp$mu.beta2.gamma[k]*0 +
    #        tmp$mu.beta3.gamma[k]*0 +
    #        tmp$mu.beta4.gamma[k]*dm.veg[i] 
    #    )
    #  }
    #}
    
    
```
```{r assemble and export community predictions}
# Put it all into one dataframe formatted for ggplot
    # Summarize the predictions in the process
    data.pred.comm <- data.frame(
      "impervious" = seq(min(data$imp1km), max(data$imp1km), length.out = npred),
      "impervious_std" = seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred),
      "het" = seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred),
      "veg" = seq(min(data$ndvi_ww1km), min(max(data$ndvi_cw1km)), length.out = npred),
      #
      "psi_urb" = apply(mu.psi.urb, c(2), function(x)   mean(x, na.rm=TRUE)),
      "psi_urb_med" = c(t(apply(mu.psi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "psi_urb_low95" = c(t(apply(mu.psi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "psi_urb_high95" = c(t(apply(mu.psi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "psi_het" = apply(mu.psi.het, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "psi_het_med" = c(t(apply(mu.psi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "psi_het_low95" = c(t(apply(mu.psi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "psi_het_high95" = c(t(apply(mu.psi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "psi_veg" = apply(mu.psi.veg, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "psi_veg_med" = c(t(apply(mu.psi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "psi_veg_low95" = c(t(apply(mu.psi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "psi_veg_high95" = c(t(apply(mu.psi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      #
      "phi_urb" = apply(mu.phi.urb, c(2), function(x)   mean(x, na.rm=TRUE)),
      "phi_urb_med" = c(t(apply(mu.phi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "phi_urb_low95" = c(t(apply(mu.phi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "phi_urb_high95" = c(t(apply(mu.phi.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "phi_het" = apply(mu.phi.het, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "phi_het_med" = c(t(apply(mu.phi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "phi_het_low95" = c(t(apply(mu.phi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "phi_het_high95" = c(t(apply(mu.phi.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "phi_veg" = apply(mu.phi.veg, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "phi_veg_med" = c(t(apply(mu.phi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "phi_veg_low95" = c(t(apply(mu.phi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "phi_veg_high95" = c(t(apply(mu.phi.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      #
      "gamma_urb" = apply(mu.gamma.urb, c(2), function(x)   mean(x, na.rm=TRUE)),
      "gamma_urb_med" = c(t(apply(mu.gamma.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "gamma_urb_low95" = c(t(apply(mu.gamma.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "gamma_urb_high95" = c(t(apply(mu.gamma.urb, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "gamma_het" = apply(mu.gamma.het, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "gamma_het_med" = c(t(apply(mu.gamma.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "gamma_het_low95" = c(t(apply(mu.gamma.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "gamma_het_high95" = c(t(apply(mu.gamma.het, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,])),
      "gamma_veg" = apply(mu.gamma.veg, c(2), function(x)   mean(x, na.rm=TRUE)) ,
      "gamma_veg_med" = c(t(apply(mu.gamma.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[1,])),
      "gamma_veg_low95" = c(t(apply(mu.gamma.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[2,])),
      "gamma_veg_high95" = c(t(apply(mu.gamma.veg, c(2), function(x)   quantile(x, prob = c(0.50, 0.025, 0.975, 0.05, 0.95)))[3,]))
      
    )

write.csv(data.pred.comm, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_commparams.csv", row.names = FALSE)

rm(mu.psi.urb,
   mu.phi.urb,
   mu.gamma.urb,
   mu.psi.het,
   mu.phi.het,
   mu.gamma.het,
   mu.psi.veg,
   mu.phi.veg,
   mu.gamma.veg)
gc()

```



### Species-level predictions vs. environmental covariates (Real Species)
```{r species predictions vs urbanization}
# initial objects for storing the predictions
    # we're going to loop the species-level predictions, so we'll need somewhere to put the outputs of each for loop
    pred.psi <- array(NA, dim = c(nsamp, nspec, npred))
    pred.phi <- array(NA, dim = c(nsamp, nspec, npred))
    pred.gamma <- array(NA, dim = c(nsamp, nspec, npred))
    
    for(s in 1:nspec){
        pred.psi[,s,] <- plogis(beta.psi[,s,] %*% t(dm.urb))
        pred.phi[,s,] <- plogis(beta.phi[,s,] %*% t(dm.urb))
        pred.gamma[,s,] <- plogis(beta.gamma[,s,] %*% t(dm.urb))
        print(data.spp$name_short[s])
    }

# Urbanization, Psi1, individual species
        pred.psi.df <- data.frame(
          cbind(
            t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T)))
            ),
          "impervious" = seq(min(data$imp1km), max(data$imp1km), length.out = npred)
        ) 
        colnames(pred.psi.df)[1:nspec] <- data.spp$name_short
        pred.psi.df <- pred.psi.df %>% pivot_longer(cols = -c(impervious), names_to = "species", values_to = "psi_med")
        
     
# Urbanization, Phi, individual species
        pred.phi.df <- data.frame(
          cbind(
            t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "impervious" = seq(min(data$imp1km), max(data$imp1km), length.out = npred)
        ) 
        colnames(pred.phi.df)[1:nspec] <- data.spp$name_short
        pred.phi.df <- pred.phi.df %>% pivot_longer(cols = -c(impervious), names_to = "species", values_to = "phi_med")
    
       
# Urbanization, Gamma, individual species
        pred.gamma.df <- data.frame(
          cbind(
            t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "impervious" = seq(min(data$imp1km), max(data$imp1km), length.out = npred)
        ) 
        colnames(pred.gamma.df)[1:nspec] <- data.spp$name_short
        pred.gamma.df <- pred.gamma.df %>% pivot_longer(cols = -c(impervious), names_to = "species", values_to = "gamma_med")
        
        
        # combine the species predictions into one dataframe with the covariates
        data.pred.sp.urb <- data.frame(
          "species" = pred.psi.df$species,
          "impervious" = rep(seq(min(data$imp1km), max(data$imp1km), length.out = npred), each = nspec),
          "impervious_std" = rep(seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred), each = nspec),
          "dietdiv" = rep(data.spp$dietdiv, npred),
          "dietdiv_std" = rep(data.spp$dietdiv_std, npred),
          "logmass" = rep(data.spp$logmass, npred),
          "logmass_std" = rep(data.spp$logmass_std, npred),
          "mass" = rep(data.spp$BodyMass.Value, npred),
          "psi_med" = pred.psi.df$psi_med,
          "phi_med" = pred.phi.df$phi_med,
          "gamma_med" = pred.gamma.df$gamma_med
        )
        
        
        
        write.csv(data.pred.sp.urb, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_22sp_urban.csv", row.names = FALSE)
```


```{r species predictions vs heterogeneity}
    pred.psi <- array(NA, dim = c(nsamp, nspec, npred)) 
    pred.phi <- array(NA, dim = c(nsamp, nspec, npred))
    pred.gamma <- array(NA, dim = c(nsamp, nspec, npred))
    
    for(s in 1:nspec){
        pred.psi[,s,] <- plogis(beta.psi[,s,] %*% t(dm.het))
        pred.phi[,s,] <- plogis(beta.phi[,s,] %*% t(dm.het))
        pred.gamma[,s,] <- plogis(beta.gamma[,s,] %*% t(dm.het))
        print(data.spp$name_short[s])
    }
    
# Urbanization, Psi1, individual species
        pred.psi.df <- data.frame(
          cbind(
            t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T)))
            ),
          "sdhi" = seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred)
        ) 
        colnames(pred.psi.df)[1:nspec] <- data.spp$name_short
        pred.psi.df <- pred.psi.df %>% pivot_longer(cols = -c(sdhi), names_to = "species", values_to = "psi_med")
        
      
  
# Urbanization, Phi, individual species
        pred.phi.df <- data.frame(
          cbind(
            t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "sdhi" = seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred)
        ) 
        colnames(pred.phi.df)[1:nspec] <- data.spp$name_short
        pred.phi.df <- pred.phi.df %>% pivot_longer(cols = -c(sdhi), names_to = "species", values_to = "phi_med")
    
       
# Urbanization, Gamma, individual species
        pred.gamma.df <- data.frame(
          cbind(
            t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "sdhi" = seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred)
        ) 
        colnames(pred.gamma.df)[1:nspec] <- data.spp$name_short
        pred.gamma.df <- pred.gamma.df %>% pivot_longer(cols = -c(sdhi), names_to = "species", values_to = "gamma_med")
        
        
        # combine the species predictions into one dataframe with the covariates
        data.pred.sp.het <- data.frame(
          "species" = pred.psi.df$species,
          "sdhi" = rep(seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred), each = nspec),
          "sdhi_std" = rep(seq(min(data$sdhi5km_std), max(data$sdhi5km_std), length.out = npred), each = nspec),
          "dietdiv" = rep(data.spp$dietdiv, npred),
          "dietdiv_std" = rep(data.spp$dietdiv_std, npred),
          "logmass" = rep(data.spp$logmass, npred),
          "logmass_std" = rep(data.spp$logmass_std, npred),
          "mass" = rep(data.spp$BodyMass.Value, npred),
          "psi_med" = pred.psi.df$psi_med,
          "phi_med" = pred.phi.df$phi_med,
          "gamma_med" = pred.gamma.df$gamma_med
        )
        
        
        
        write.csv(data.pred.sp.het, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_22sp_heterogeneity.csv", row.names = FALSE)
```

```{r species predictions vs vegetation}
    pred.psi <- array(NA, dim = c(nsamp, nspec, npred))  
    pred.phi <- array(NA, dim = c(nsamp, nspec, npred))
    pred.gamma <- array(NA, dim = c(nsamp, nspec, npred))
    
    for(s in 1:nspec){
        pred.psi[,s,] <- plogis(beta.psi[,s,] %*% t(dm.veg))
        pred.phi[,s,] <- plogis(beta.phi[,s,] %*% t(dm.veg))
        pred.gamma[,s,] <- plogis(beta.gamma[,s,] %*% t(dm.veg))
        print(data.spp$name_short[s])
    }
    
# Psi1, individual species
        pred.psi.df <- data.frame(
          cbind(
            t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T)))
            ),
          "veg" = seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred)
        ) 
        colnames(pred.psi.df)[1:nspec] <- data.spp$name_short
        pred.psi.df <- pred.psi.df %>% pivot_longer(cols = -c(veg), names_to = "species", values_to = "psi_med")
        
      
  
# Phi, individual species
        pred.phi.df <- data.frame(
          cbind(
            t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "veg" = seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred)
        ) 
        colnames(pred.phi.df)[1:nspec] <- data.spp$name_short
        pred.phi.df <- pred.phi.df %>% pivot_longer(cols = -c(veg), names_to = "species", values_to = "phi_med")
    
       
# Gamma, individual species
        pred.gamma.df <- data.frame(
          cbind(
            t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T)))
          ),
          "veg" = seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred)
        ) 
        colnames(pred.gamma.df)[1:nspec] <- data.spp$name_short
        pred.gamma.df <- pred.gamma.df %>% pivot_longer(cols = -c(veg), names_to = "species", values_to = "gamma_med")
        
        
        # combine the species predictions into one dataframe with the covariates
        data.pred.sp.veg <- data.frame(
          "species" = pred.psi.df$species,
          "veg" = rep(seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred), each = nspec),
          "veg_std" = rep(seq(min(ndvi.1km.std), max(ndvi.1km.std), length.out = npred), each = nspec),
          "dietdiv" = rep(data.spp$dietdiv, npred),
          "dietdiv_std" = rep(data.spp$dietdiv_std, npred),
          "logmass" = rep(data.spp$logmass, npred),
          "logmass_std" = rep(data.spp$logmass_std, npred),
          "mass" = rep(data.spp$BodyMass.Value, npred),
          "psi_med" = pred.psi.df$psi_med,
          "phi_med" = pred.phi.df$phi_med,
          "gamma_med" = pred.gamma.df$gamma_med
        )
        
        
        
        write.csv(data.pred.sp.veg, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_22sp_vegetation.csv", row.names = FALSE)
```



### Species-level predictions vs. traits and environmental covariates (Species with Idealized Traits)
```{r matrices with trait effects}
# Grab the appropriate intercept and slope parameters for the species traits
    # psi
    beta.psi.int <- cbind(tmp$mu.lpsi, tmp$dint.psi.trait1, tmp$dint.psi.trait2)
    beta.psi.urb <- cbind(tmp$mu.beta1.psi, tmp$deff1.psi.trait1, tmp$deff1.psi.trait2)
    # beta.psi.urbquad <- cbind(tmp$mu.beta2.psi, tmp$deff2.psi.trait1, tmp$deff2.psi.trait2)
    beta.psi.het <- cbind(tmp$mu.beta3.psi, tmp$deff3.psi.trait1, tmp$deff3.psi.trait2)
    beta.psi.veg <- cbind(tmp$mu.beta4.psi, tmp$deff4.psi.trait1, tmp$deff4.psi.trait2)
    # phi
    beta.phi.int <- cbind(tmp$mu.lphi, tmp$dint.phi.trait1, tmp$dint.phi.trait2)
    beta.phi.urb <- cbind(tmp$mu.beta1.phi, tmp$deff1.phi.trait1, tmp$deff1.phi.trait2)
    # beta.phi.urbquad <- cbind(tmp$mu.beta2.phi, tmp$deff2.phi.trait1, tmp$deff2.phi.trait2)
    beta.phi.het <- cbind(tmp$mu.beta3.phi, tmp$deff3.phi.trait1, tmp$deff3.phi.trait2)
    beta.phi.veg <- cbind(tmp$mu.beta4.phi, tmp$deff4.phi.trait1, tmp$deff4.phi.trait2)
    # gamma
    beta.gamma.int <- cbind(tmp$mu.lgamma, tmp$dint.gamma.trait1, tmp$dint.gamma.trait2)
    beta.gamma.urb <- cbind(tmp$mu.beta1.gamma, tmp$deff1.gamma.trait1, tmp$deff1.gamma.trait2)
    # beta.gamma.urbquad <- cbind(tmp$mu.beta2.gamma, tmp$deff2.gamma.trait1, tmp$deff2.gamma.trait2)
    beta.gamma.het <- cbind(tmp$mu.beta3.gamma, tmp$deff3.gamma.trait1, tmp$deff3.gamma.trait2)
    beta.gamma.veg <- cbind(tmp$mu.beta4.gamma, tmp$deff4.gamma.trait1, tmp$deff4.gamma.trait2)
```
```{r predict covariate effects across species traits}
beta.psi.bm <- abind(
            (beta.psi.int %*% t(dm.bm)),
            (beta.psi.urb %*% t(dm.bm)),
            # (beta.psi.urbquad %*% t(dm.bm)),
            (beta.psi.het %*% t(dm.bm)),
            (beta.psi.veg %*% t(dm.bm)),
            along = 3)

beta.psi.di <- abind(
            (beta.psi.int %*% t(dm.di)),
            (beta.psi.urb %*% t(dm.di)),
            # (beta.psi.urbquad %*% t(dm.di)),
            (beta.psi.het %*% t(dm.di)),
            (beta.psi.veg %*% t(dm.di)),
            along = 3)

beta.phi.bm <- abind(
            (beta.phi.int %*% t(dm.bm)),
            (beta.phi.urb %*% t(dm.bm)),
            # (beta.phi.urbquad %*% t(dm.bm)),
            (beta.phi.het %*% t(dm.bm)),
            (beta.phi.veg %*% t(dm.bm)),
            along = 3)

beta.phi.di <- abind(
            (beta.phi.int %*% t(dm.di)),
            (beta.phi.urb %*% t(dm.di)),
            # (beta.phi.urbquad %*% t(dm.di)),
            (beta.phi.het %*% t(dm.di)),
            (beta.phi.veg %*% t(dm.di)),
            along = 3)

beta.gamma.bm <- abind(
            (beta.gamma.int %*% t(dm.bm)),
            (beta.gamma.urb %*% t(dm.bm)),
            # (beta.gamma.urbquad %*% t(dm.bm)),
            (beta.gamma.het %*% t(dm.bm)),
            (beta.gamma.veg %*% t(dm.bm)),
            along = 3)

beta.gamma.di <- abind(
            (beta.gamma.int %*% t(dm.di)),
            (beta.gamma.urb %*% t(dm.di)),
            # (beta.gamma.urbquad %*% t(dm.di)),
            (beta.gamma.het %*% t(dm.di)),
            (beta.gamma.veg %*% t(dm.di)),
            along = 3)
```

```{r dataframes for species predictions}
data.pred.bm <- data.frame(
        "index" = rep(c(1:npred), each = nspec.pred),
        "species" = rep(paste("sp", 1:nspec.pred, sep = ""), npred),
        "logmass" = rep(plot.bm, npred),
        "logmass_std" = rep(dm.bm[,2], npred),
        "impervious" = rep(seq(min(data$imp1km), max(data$imp1km), length.out = npred), each = nspec.pred),
        "impervious_std" = rep(seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred), each = nspec.pred),
        "sdhi" = rep(seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred), each = nspec.pred),
        "sdhi_std" = rep(seq(min(data$sdhi5km_std), max(data$sdhi5km_std), length.out = npred), each = nspec.pred),
        "veg" = rep(seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred), each = nspec.pred),
        "veg_std" = rep(seq(min(ndvi.1km.std), max(ndvi.1km.std), length.out = npred), each = nspec.pred)
      )

data.pred.di <- data.frame(
        "index" = rep(c(1:npred), each = nspec.pred),
        "species" = rep(paste("sp", 1:nspec.pred, sep = ""), npred),
        "dietdiv" = rep(plot.di, npred),
        "dietdiv_std" = rep(dm.di[,3], npred),
        "impervious" = rep(seq(min(data$imp1km), max(data$imp1km), length.out = npred), each = nspec.pred),
        "impervious_std" = rep(seq(min(data$imp1km_std), max(data$imp1km_std), length.out = npred), each = nspec.pred),
        "sdhi" = rep(seq(min(data$sdhi5km), max(data$sdhi5km), length.out = npred), each = nspec.pred),
        "sdhi_std" = rep(seq(min(data$sdhi5km_std), max(data$sdhi5km_std), length.out = npred), each = nspec.pred),
        "veg" = rep(seq(min(data$ndvi_ww1km), max(data$ndvi_cw1km), length.out = npred), each = nspec.pred),
        "veg_std" = rep(seq(min(ndvi.1km.std), max(ndvi.1km.std), length.out = npred), each = nspec.pred)
      )
```


```{r predict urbanization effects by size, warning = FALSE}
# objects for storing data produced by loops
  # the second dimension will be the number of "species" to predict for
  # 3 being the number of summary stats (lower CRI, median, upper CRI)
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.bm[,s,] %*% t(dm.urb))
        pred.phi[,s,] <- plogis(beta.phi.bm[,s,] %*% t(dm.urb))
        pred.gamma[,s,] <- plogis(beta.gamma.bm[,s,] %*% t(dm.urb))
        print(s)
}
  
      
      data.pred.bm$psi_urb_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.bm$psi_urb_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.bm$psi_urb_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      # repeat for the remaining parameters
      data.pred.bm$phi_urb_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_urb_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_urb_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.bm$gamma_urb_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_urb_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_urb_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```

```{r predict heterogeneity effects by size, warning = FALSE}
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.bm[,s,] %*% t(dm.het))
        pred.phi[,s,] <- plogis(beta.phi.bm[,s,] %*% t(dm.het))
        pred.gamma[,s,] <- plogis(beta.gamma.bm[,s,] %*% t(dm.het))
        print(s)
}
  
      
      data.pred.bm$psi_het_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$psi_het_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$psi_het_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_het_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_het_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_het_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_het_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_het_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_het_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```

```{r predict vegetation effects by size, warning = FALSE}
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.bm[,s,] %*% t(dm.veg))
        pred.phi[,s,] <- plogis(beta.phi.bm[,s,] %*% t(dm.veg))
        pred.gamma[,s,] <- plogis(beta.gamma.bm[,s,] %*% t(dm.veg))
        print(s)
}
  
      
      data.pred.bm$psi_veg_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$psi_veg_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$psi_veg_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_veg_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_veg_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$phi_veg_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_veg_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_veg_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.bm$gamma_veg_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```

```{r predict urbanization effects by diet, warning = FALSE}
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.di[,s,] %*% t(dm.urb))
        pred.phi[,s,] <- plogis(beta.phi.di[,s,] %*% t(dm.urb))
        pred.gamma[,s,] <- plogis(beta.gamma.di[,s,] %*% t(dm.urb))
        print(s)
}
  
      
      data.pred.di$psi_urb_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.di$psi_urb_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.di$psi_urb_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      # repeat for the remaining parameters
      data.pred.di$phi_urb_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_urb_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_urb_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
      data.pred.di$gamma_urb_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_urb_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_urb_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```

```{r predict heterogeneity effects by diet, warning = FALSE}
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.di[,s,] %*% t(dm.het))
        pred.phi[,s,] <- plogis(beta.phi.di[,s,] %*% t(dm.het))
        pred.gamma[,s,] <- plogis(beta.gamma.di[,s,] %*% t(dm.het))
        print(s)
}
  
      
      data.pred.di$psi_het_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$psi_het_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$psi_het_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_het_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_het_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_het_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_het_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_het_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_het_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```

```{r predict vegetation effects by diet, warning = FALSE}
  pred.phi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.psi <- array(NA, dim = c(nsamp, nspec.pred, npred))
  pred.gamma <- array(NA, dim = c(nsamp, nspec.pred, npred)) 
          
          
for(s in 1:nspec.pred){
        pred.psi[,s,] <- plogis(beta.psi.di[,s,] %*% t(dm.veg))
        pred.phi[,s,] <- plogis(beta.phi.di[,s,] %*% t(dm.veg))
        pred.gamma[,s,] <- plogis(beta.gamma.di[,s,] %*% t(dm.veg))
        print(s)
}
  
      
      data.pred.di$psi_veg_med <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$psi_veg_low95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$psi_veg_high95 <- data.frame(
        t(apply(pred.psi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_veg_med <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_veg_low95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$phi_veg_high95 <- data.frame(
        t(apply(pred.phi, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_veg_med <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   median(x, na.rm = T))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_veg_low95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.025)))),
        "index" = c(1:npred)
      )  %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      data.pred.di$gamma_veg_high95 <- data.frame(
        t(apply(pred.gamma, c(2,3), function(x)   quantile(x, na.rm = T, probs = c(0.975)))),
        "index" = c(1:npred)
      ) %>% pivot_longer(cols = -c(index)) %>% pull(value)
      
      
```
```{r export trait predictions}
data.pred.bm
data.pred.di


write.csv(data.pred.bm, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_ideal_3spp_size.csv", row.names = FALSE)
write.csv(data.pred.di, "~/GitHub/metrophxwildlife-communitydynamics/data/model_outputs/predictions_ideal_3spp_diet.csv", row.names = FALSE)
```
```{r}
ggplot() +
          theme_classic()+
          geom_smooth(data = data.pred.bm, aes(x = impervious, y = psi_urb_med, group = species), se = FALSE)
```